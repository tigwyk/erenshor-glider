# Ralph Progress Log
Started: Thu Feb  6 09:45:00 PST 2026
Branch: ralph/auto-installation
Feature: Automated BepInEx installation and plugin management

## Codebase Patterns
---

## Fri Feb  7 10:30:00 PST 2026 - US-001
- Created installation service infrastructure with IInstallationService interface and InstallationService implementation
- Added IInstallationService.cs with interface, InstallationStatus enum, InstallationResult class, and DownloadProgress class
- Added InstallationService.cs with HttpClient, cache directory management, Steam registry detection, download/install methods
- Added System.IO.Compression and System.Net.Http package references to GUI project
- Files changed:
  - src/ErenshorGlider.GUI/Installation/IInstallationService.cs (new)
  - src/ErenshorGlider.GUI/Installation/InstallationService.cs (new)
  - src/ErenshorGlider.GUI/ErenshorGlider.GUI.csproj (added package references)
- **Learnings for future iterations:**
  - .NET Framework 4.7.2 doesn't support init-only properties - use private setters instead
  - Need to explicitly add System.Net.Http and System.IO.Compression NuGet packages for .NET Framework 4.7.2
  - Nullable reference types require careful handling with `string?` for nullable returns
  - This codebase uses `Nullable` enabled - need to annotate nullable returns properly
  - Cache directory pattern: LocalApplicationData + "ErenshorGlider/cache"
  - Service class follows IDisposable pattern for HttpClient cleanup

## Fri Feb  7 11:00:00 PST 2026 - US-006
- Implemented GitHub version checking for plugin updates
- Added CheckForUpdatesAsync method to InstallationService that queries GitHub API
- Created UpdateCheckResult class with HasUpdate, LatestVersion, CurrentVersion, ReleaseNotes, and DownloadUrl properties
- Added version comparison logic using System.Version parsing
- Handled offline mode and GitHub API rate limiting gracefully
- Files changed:
  - src/ErenshorGlider.GUI/Installation/IInstallationService.cs (added CheckForUpdatesAsync, UpdateCheckResult)
  - src/ErenshorGlider.GUI/Installation/InstallationService.cs (implemented CheckForUpdatesAsync with GitHub API)
- **Learnings for future iterations:**
  - Use GitHub API releases/latest endpoint for version checking
  - GitHub API returns 403 Forbidden when rate limited - handle gracefully
  - Use System.Text.Json for JSON parsing (already in dependencies)
  - Version.Parse() requires version format (e.g., "1.0.0"), strip 'v' prefix if present
  - Use null-forgiving operator (!) when compiler can't recognize null check guards
  - Static factory methods pattern (UpdateAvailable, NoUpdate, Failed) for result objects

## Fri Feb  7 11:30:00 PST 2026 - US-007
- Implemented plugin download and update installation
- Added UpdatePluginAsync method that downloads and installs the latest plugin DLL
- Downloads from GitHub releases API, finds ErenshorGlider.dll asset
- Backs up existing DLL before installation (creates .backup file)
- Reports progress during download (0-50%) and installation (50-100%)
- Handles download failures and file lock errors gracefully
- Files changed:
  - src/ErenshorGlider.GUI/Installation/IInstallationService.cs (added UpdatePluginAsync to interface)
  - src/ErenshorGlider.GUI/Installation/InstallationService.cs (implemented UpdatePluginAsync with GitHub download)
- **Learnings for future iterations:**
  - Download to temp file in cache directory first, then copy to destination
  - Use HttpCompletionOption.ResponseHeadersRead for streaming large downloads
  - Report progress as percentage of total work (download + install)
  - Backup strategy: copy existing file to .backup before overwriting
  - Clean up temp files after installation (ignore cleanup errors)

## Fri Feb  7 12:00:00 PST 2026 - US-008
- Implemented game process management
- Added IsGameRunning method to check for Erenshor.exe process
- Added LaunchGameAsync method to start the game process
- Created GameLaunchResult class with Success, ErrorMessage, ProcessId properties
- Added GameExited event for process termination notification
- Monitors game process in background thread using ThreadPool
- Files changed:
  - src/ErenshorGlider.GUI/Installation/IInstallationService.cs (added IsGameRunning, LaunchGameAsync, GameExited event, GameLaunchResult)
  - src/ErenshorGlider.GUI/Installation/InstallationService.cs (implemented process management with background monitoring)
- **Learnings for future iterations:**
  - Use System.Diagnostics.Process.GetProcessesByName() to check if process is running
  - Use ProcessStartInfo with UseShellExecute=true for launching game executables
  - Process monitoring requires background thread - use ThreadPool.QueueUserWorkItem
  - Track process instance in class field for cleanup and monitoring
  - Dispose process after exit to free resources

## Fri Feb  7 12:30:00 PST 2026 - US-009
- Added installation configuration persistence
- Created InstallationConfig class with ErenshorPath, LastUpdateCheck, OptOutFromUpdateChecks, LastInstalledPluginVersion
- Created InstallationConfigManager with Load, Save, Delete static methods
- Config saves to LocalApplicationData/ErenshorGlider/installation.json
- Loads config on service initialization, returns null if file doesn't exist
- Handles JSON deserialization errors gracefully by returning default config
- Added Config property and SaveConfig method to IInstallationService
- Files changed:
  - src/ErenshorGlider.GUI/Installation/InstallationConfig.cs (new)
  - src/ErenshorGlider.GUI/Installation/IInstallationService.cs (added Config property, SaveConfig method)
  - src/ErenshorGlider.GUI/Installation/InstallationService.cs (load config in constructor, implement SaveConfig)
- **Learnings for future iterations:**
  - Follow existing ConfigManager pattern (like BotConfig.ConfigManager) for consistency
  - Use camelCase JSON naming policy for config files
  - Handle JSON deserialization errors by returning default/empty config
  - Make Load() return nullable for "not found" vs "error" distinction
  - Use same LocalApplicationData base directory for all app data

## Fri Feb  7 13:00:00 PST 2026 - US-010
- Created installation status display panel
- Added InstallationStatusPanel control in ErenshorGlider.GUI/Controls
- Shows BepInEx and plugin status with icon indicators (✓ installed, ⚠ update available, ✗ not installed)
- Displays installed versions for both BepInEx and plugin
- Shows Erenshor installation path with path shortening for long paths
- Added Refresh button for manual status refresh
- Auto-refreshes every 5 seconds via Timer
- Styled to match existing GUI theme (dark colors, consistent fonts)
- Version detection via version.txt file and FileVersionInfo for DLLs
- Files changed:
  - src/ErenshorGlider.GUI/Controls/InstallationStatusPanel.cs (new)
- **Learnings for future iterations:**
  - GUI panel naming convention: [Subject]StatusPanel for status displays
  - Use unicode characters for status icons (✓, ⚠, ✗) instead of images
  - Status icons use specific colors: red (180,80,80) for error, green (100,180,100) for success, yellow (220,180,80) for warning
  - Timer-based auto-refresh uses 5 second interval (5000ms)
  - For fire-and-forget async in constructors, use `#pragma warning disable CS4014` with `_ = Method()` pattern
  - Use null-forgiving operator (!) when compiler can't recognize null check guards after string.IsNullOrEmpty
  - Version detection fallback: check version.txt first, then FileVersionInfo on DLL
  - ShortenPath utility keeps filename visible and truncates directory with "..." prefix
  - Panel background color: Color.FromArgb(40, 40, 43) for consistency
  - Button hover effect lightens color by 20 RGB units

## Fri Feb  7 15:00:00 PST 2026 - US-012
- Created first-run setup wizard
- Created SetupWizard Form with multi-step layout in ErenshorGlider.GUI/Forms
- Step 1: Welcome screen with feature list
- Step 2: Erenshor detection with auto-detect from Steam and manual browse button
- Step 3: BepInEx installation with progress bar
- Step 4: Plugin installation with progress bar
- Step 5: Complete screen with 'Launch Game' button
- Added Back/Next/Cancel navigation buttons
- Styled to match existing GUI theme (dark colors, consistent fonts)
- Validates Erenshor.exe exists in selected folder
- Shows progress during download and installation (Progress<DownloadProgress>)
- Saves configuration to InstallationConfig via SaveConfig()
- Uses FolderBrowserDialog for manual path selection
- Files changed:
  - src/ErenshorGlider.GUI/Forms/SetupWizard.cs (new)
- **Learnings for future iterations:**
  - Wizard pattern: create Form with _currentStep int tracking, switch on step number in ShowStep()
  - Fixed dialog size (650x500) works well for wizard layouts
  - ContentPanel (590x300) with step-specific content, buttons positioned at bottom right
  - ProgressBarStyle.Marquee for indeterminate progress, Continuous for determinate
  - Download progress reported as percentage (0-50% download, 50-100% install)
  - Use SetInstallationInProgress(bool) to disable all navigation buttons during operations
  - Step-specific content: clear _contentPanel.Controls and add new controls for each step
  - FormBorderStyle = FormBorderStyle.FixedDialog for wizard-style non-resizable window
  - Use FolderBrowserDialog with ShowNewFolderButton = false for installation selection
  - Auto-detect from Steam via _installationService.DetectErenshorPathAsync()
  - Validate path contains Erenshor.exe before proceeding

## Fri Feb  7 16:00:00 PST 2026 - US-013
- Added manual directory browser dialog to InstallationService
- Added BrowseForErenshorPathAsync method to IInstallationService interface
- Implemented in InstallationService using FolderBrowserDialog
- Validates selected path contains Erenshor.exe before returning
- Returns validated path or null if cancelled/invalid
- Shows clear error message for invalid selection via MessageBox
- Uses SynchronizationContext to show dialog on UI thread
- Added System.Windows.Forms using to InstallationService.cs
- Files changed:
  - src/ErenshorGlider.GUI/Installation/IInstallationService.cs (added method to interface)
  - src/ErenshorGlider.GUI/Installation/InstallationService.cs (implemented method)
- **Learnings for future iterations:**
  - FolderBrowserDialog requires STAThread, but our service may be called from different threads
  - Use WindowsFormsSynchronizationContext.Current to detect if we're on UI thread
  - Use syncContext.Send() to execute code on UI thread
  - Service layer showing UI dialogs is a pattern to avoid in future - keep UI in UI layer
  - ValidateErenshorPath is private static - could be made public for reuse
  - MessageBox with MessageBoxIcon.Warning for validation errors
  - ShowNewFolderButton = false prevents users from creating new folders (we want existing install only)

## Fri Feb  7 14:00:00 PST 2026 - US-011
- Added installation buttons to main window
- Added InstallPlugin button (blue) to MainWindow header area
- Added LaunchGame button (green) to MainWindow header area
- Buttons disable when game is running via UpdateGameRunningButtons method
- Install button shows confirmation message on success
- Launch button starts Erenshor.exe from configured path
- Shows error dialog if Erenshor path not configured
- Styled buttons to match existing theme
- Added IInstallationService parameter to MainWindow constructor (nullable for backward compatibility)
- Added HandleInstallPluginClick async handler with progress dialog
- Added HandleLaunchGameClick async handler
- Added CreateProgressDialog for showing progress during operations
- Wired up GameExited event to re-enable buttons when game closes
- Files changed:
  - src/ErenshorGlider.GUI/MainWindow.cs (added buttons, handlers, service parameter)
- **Learnings for future iterations:**
  - MainWindow constructor overload pattern: add new parameters with default null for backward compatibility
  - Button layout in header: position from right to left with fixed X coordinates
  - Header needs more width (370px instead of 120px) when adding multiple buttons
  - Progress dialog pattern: CreateProgressDialog returns Form with ProgressBar in Marquee style
  - Use `using var` for progress dialog to ensure proper disposal
  - MessageBox icons: Information for success, Warning for missing config, Error for failures
  - Check IsGameRunning before both install and launch operations
  - Get plugin DLL path from Application.ExecutablePath directory
---

## [Date/Time] - US-014
- Added update notification display to InstallationStatusPanel
- Created update notification panel with yellow/orange theme that appears when updates are available
- Added "Update Now" button with async handler to download and install plugin updates
- Added "View release notes" link that opens dialog showing changelog from GitHub
- Added CheckForUpdatesAsync method to panel for async update checking
- Added update progress dialog with percentage display during download/install
- Integrated startup update check in MainWindow with balloon notification
- Balloon shows current and latest version when update available
- Update notification panel auto-shows/hides based on update availability
- Panel adjusts minimum height (190px when visible, 140px when hidden)
- Files changed:
  - src/ErenshorGlider.GUI/Controls/InstallationStatusPanel.cs (added update notification UI, handlers, dialogs)
  - src/ErenshorGlider.GUI/MainWindow.cs (added startup update check with balloon notification)
- **Learnings for future iterations:**
  - Update notification panel should dock to top and overlay existing content rather than pushing it down
  - Use Progress<DownloadProgress> for reporting update progress to UI
  - Balloon notifications via NotifyIcon.ShowBalloonTip with 3000ms timeout
  - Fire-and-forget async pattern with pragma warning disable CS4014 for startup tasks
  - LinkLabel for clickable links like "View release notes"
  - Dialog for release notes uses multiline TextBox with ReadOnly=true and ScrollBars=Vertical
  - Panel height adjustment based on visibility: update MinimumSize when showing/hiding notification
  - Theme colors: update notification uses (60,50,40) background, (255,220,100) text
---
