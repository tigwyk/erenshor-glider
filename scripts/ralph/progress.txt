# Ralph Progress Log
Started: Wed Feb  5 06:30:00 PST 2026
Branch: ralph/game-integration
Feature: Replace stub implementations with real Erenshor game API integration using Assembly-CSharp.dll

## Codebase Patterns
- Conditional compilation: Use `#if !USE_REAL_GAME_TYPES` to toggle between stub and real game types
- P/Invoke Windows API: Use `[DllImport("user32.dll", SetLastError = true)]` for native Windows functions
- Native struct marshaling: Use `[StructLayout(LayoutKind.Sequential)]` for structs passed to native code
- Virtual Key codes: Windows VK constants (0x57='W', 0x20=Space, 0x09=Tab, etc.)
- SendInput error handling: Check return value (0=failure), use `Marshal.GetLastWin32Error()` for error code
- Input state tracking: Maintain internal key state dictionary for `IsKeyPressed` queries separate from Windows API
---

## [2025-02-05] - US-001
- Added conditional compilation support for toggling between stub and real game types
- Added USE_REAL_GAME_TYPES compilation constant to csproj
- Added conditional assembly references to Assembly-CSharp.dll and UnityEngine.dll (only active when USE_REAL_GAME_TYPES=true and ERENSHOR_PATH is set)
- Wrapped GameStubs/GameData.cs with #if !USE_REAL_GAME_TYPES to exclude stubs when using real types
- Updated GameStateReader.cs to conditionally use stubs
- Fixed pre-existing nullable reference warnings in RestController.cs, RotationExecutor.cs, ExportImportManager.cs, and GrindingBot.cs
- Suppressed unused event warning in Navigation.cs

**Files changed:**
- src/ErenshorGlider/ErenshorGlider.csproj - Added conditional assembly references
- src/ErenshorGlider/GameStubs/GameData.cs - Added #if !USE_REAL_GAME_TYPES wrapper
- src/ErenshorGlider/GameState/GameStateReader.cs - Added conditional using statement
- src/ErenshorGlider/Navigation/Navigation.cs - Suppressed CS0067
- src/ErenshorGlider/Combat/RestController.cs - Fixed nullable warnings
- src/ErenshorGlider/Combat/RotationExecutor.cs - Fixed nullable warnings
- src/ErenshorGlider/ImportExport/ExportImportManager.cs - Fixed nullable warnings
- src/ErenshorGlider/Bot/GrindingBot.cs - Fixed nullable warnings

**Learnings for future iterations:**
- The project uses `Nullable` enabled type checking, which requires careful handling of nullable reference types
- When USE_REAL_GAME_TYPES is defined but ERENSHOR_PATH is not set, the build shows a warning but still attempts to compile
- The stub types (GameData, PlayerControl, Character, etc.) need to match the real game API signatures exactly for the conditional compilation to work seamlessly
- The ItemQuality enum exists in both GameState namespace (used by PlayerInventory struct) and GameStubs namespace - these are intentionally separate
- The prd.json branch name was "ralph/game-integration" but the actual branch was "ralph/erenshor-glider" - created new branch as specified

**Build verification:**
- Default build (without USE_REAL_GAME_TYPES): PASS (0 warnings, 0 errors)
- With USE_REAL_GAME_TYPES but no ERENSHOR_PATH: Fails (expected - needs actual game DLLs)
---

## [2025-02-05] - US-002
- Created ErenshorGlider.Tests project for unit testing without game dependencies
- Moved GameStubs classes to test project (GameStubs/GameData.cs) - copies remain in main project with conditional compilation
- Added TestStubsSetup helper class for convenient mock object creation
- Created PositionTrackerTests with 17 unit tests covering GameStateReader, PlayerPosition, PlayerVitals, CombatState, and TargetInfo
- Test project compiles independently of game assemblies using UnityEngine.Modules NuGet package
- All projects build with 0 warnings, 0 errors

**Files changed:**
- src/ErenshorGlider.Tests/ErenshorGlider.Tests.csproj - New test project with xUnit
- src/ErenshorGlider.Tests/GameStubs/GameData.cs - Stub implementations for testing
- src/ErenshorGlider.Tests/Helpers/TestStubsSetup.cs - Helper for creating mock game objects
- src/ErenshorGlider.Tests/GameState/PositionTrackerTests.cs - 17 unit tests

**Learnings for future iterations:**
- The test project targets .NET Framework 4.7.2 (same as main project) and uses xUnit for testing
- UnityEngine.Modules NuGet package provides Unity type stubs for compilation without game DLLs
- Tests require mono runtime to execute on Linux (not installed in current environment) but compile successfully
- Used null-forgiving operator (!) to suppress nullable warnings when assigning null to non-nullable stub fields
- Fully qualified type names (e.g., GameStubs.ItemQuality) needed to avoid ambiguity with GameState.ItemQuality

**Build verification:**
- ErenshorGlider.Tests build: PASS (0 warnings, 0 errors)
- Test execution: Requires mono/.NET Framework runtime on Windows
---

## [2025-02-05] - US-003
- Created WindowsInputSimulator static class with Windows API P/Invoke declarations
- Implemented KEYBDINPUT structure for keyboard events (wVk, wScan, dwFlags, time, dwExtraInfo)
- Implemented INPUT struct with Data union for marshaling to native code
- Added PressKey(KeyCode) to send KEYEVENTF_KEYDOWN via SendInput
- Added ReleaseKey(KeyCode) to send KEYEVENTF_KEYUP via SendInput
- Added PressAndReleaseKey(KeyCode, durationMs) for complete key press simulation
- Added error handling with Marshal.GetLastWin32Error() and debug output
- Mapped all KeyCode enums to Windows Virtual Key codes (letter keys, special keys, arrows, numbers, function keys)
- Integrated WindowsInputSimulator into InputController with UseWindowsInputSimulation toggle property (default true)
- Preserved internal key state tracking (KeyStates dictionary) for game logic that uses IsKeyPressed
- Added UpArrow and DownArrow to KeyCode enum for completeness
- All projects build with 0 warnings, 0 errors

**Files changed:**
- src/ErenshorGlider/Input/WindowsInputSimulator.cs - New file with Windows API input simulation
- src/ErenshorGlider/Input/InputController.cs - Integrated WindowsInputSimulator, added UpArrow/DownArrow to KeyCode

**Learnings for future iterations:**
- The Windows API SendInput function requires P/Invoke with [DllImport("user32.dll", SetLastError = true)]
- INPUT struct uses LayoutKind.Sequential for correct marshaling to native code
- Virtual Key codes are standard Windows constants (e.g., 0x57 for 'W', 0x20 for Space)
- SendInput returns 0 on failure - use Marshal.GetLastWin32Error() to get error code
- The INPUT union is simplified to only use Keyboard field since we don't need mouse/hardware input
- Preserving internal key state tracking allows the game logic to query IsKeyPressed without Windows API calls
- UseWindowsInputSimulation property allows disabling Windows input for testing or GUI-only scenarios

**Build verification:**
- ErenshorGlider build: PASS (0 warnings, 0 errors)
- Typecheck: PASS
---

## [2025-02-05] - US-004
- Replaced Navigation.GetPlayerRotation() stub with real implementation
- Reads from GameData.PlayerControl.transform.rotation.eulerAngles.y
- Added null safety checks for PlayerControl and transform
- Normalizes rotation to 0-360 degree range
- Added try/catch for graceful error handling during scene transitions
- Added conditional compilation (#if !USE_REAL_GAME_TYPES) for stub mode
- Created NavigationTests.cs with 11 unit tests
- Tests cover CalculateDistance, CalculateDirection, HasReached, MoveTo, FaceTarget, IsFacing
- All projects build with 0 warnings, 0 errors

**Files changed:**
- src/ErenshorGlider/Navigation/Navigation.cs - Implemented real GetPlayerRotation(), added conditional using
- src/ErenshorGlider.Tests/Navigation/NavigationTests.cs - New test file with 11 unit tests

**Learnings for future iterations:**
- Unity Transform.rotation returns a Quaternion with eulerAngles property (Vector3)
- eulerAngles.y is the Y-axis rotation (yaw/heading) in degrees
- Need to normalize angles to 0-360 range for consistent comparison
- Conditional compilation pattern: #if !USE_REAL_GAME_TYPES for stub-specific code
- TestStubsSetup.CreateMockPlayer() provides test fixtures with transform and position
- Navigation tests verify public API behavior (FaceTarget, HasReached) which indirectly tests GetPlayerRotation

**Build verification:**
- ErenshorGlider build: PASS (0 warnings, 0 errors)
- Typecheck: PASS
---

## [2025-02-05] - US-005
- Added auto-attack functionality to CombatController
- Added UseAutoAttack property (default true)
- EnableAutoAttack() calls GameData.PlayerCombat.ForceAttackOn() for immediate effect
- DisableAutoAttack() checks InCombat state before calling ToggleAttack()
- Auto-attack enabled in EngageTarget() when UseAutoAttack=true and target is hostile
- Auto-attack disabled in StopCombat() for all combat end reasons
- Null safety checks for PlayerCombat
- Try/catch for graceful error handling during scene transitions
- Conditional compilation (#if !USE_REAL_GAME_TYPES) for stub mode
- All projects build with 0 warnings, 0 errors

**Files changed:**
- src/ErenshorGlider/Combat/CombatController.cs - Added auto-attack functionality with conditional compilation

**Learnings for future iterations:**
- GameData.PlayerCombat.ForceAttackOn() immediately enables auto-attack
- GameData.PlayerCombat.ToggleAttack() toggles the current state
- GameData.PlayerCombat.InCombat indicates whether auto-attack is currently enabled
- Check target hostility (TargetHostility.Hostile) before enabling auto-attack to avoid attacking friendly targets
- Disable auto-attack on all combat end conditions to prevent unwanted attacks after combat

**Build verification:**
- ErenshorGlider build: PASS (0 warnings, 0 errors)
- Typecheck: PASS
---

## [2025-02-05] - US-006
- Added InstanceId property to EntityInfo struct (default 0)
- Updated EntityInfo constructor to include instanceId parameter
- Updated all EntityInfo creation sites to capture Unity instance ID from gameObject
  - CreateEntityInfoFromCharacter: gets instanceId from character.gameObject
  - CreateEntityInfoFromNPC: gets instanceId from npc.gameObject
  - CreateEntityInfoFromNode: gets instanceId from node.gameObject
  - CreateEntityInfoFromCorpse: gets instanceId from corpse.gameObject
- Implemented InputController.TargetEntityById() with real game API
  - Uses Object.FindObjectsOfType<Character>() to search all entities
  - Compares GetInstanceID() to find matching entity
  - Sets GameData.PlayerControl.CurrentTarget to found entity
  - Null safety checks for PlayerControl and entity lookup
  - Falls back to event-based approach on error
- Implemented InputController.TargetEntity() to delegate to TargetEntityById()
- Added FindEntityByInstanceId() helper method with conditional compilation
- All projects build with 0 warnings, 0 errors

**Files changed:**
- src/ErenshorGlider/Input/InputController.cs - Implemented TargetEntityById() and FindEntityByInstanceId()
- src/ErenshorGlider/GameState/EntityInfo.cs - Added InstanceId property
- src/ErenshorGlider/GameState/GameStateReader.cs - Capture instance ID when creating EntityInfo

**Learnings for future iterations:**
- Unity GameObject.GetInstanceID() returns a unique integer ID for each object
- Object.FindObjectsOfType<Character>() returns all objects of the given type (includes subclasses)
- Need null check for gameObject before calling GetInstanceID()
- Setting CurrentTarget directly is more reliable than keyboard input for targeting
- Event-based fallback allows testing without game assemblies

**Build verification:**
- ErenshorGlider build: PASS (0 warnings, 0 errors)
- Typecheck: PASS
---

## [2025-02-05] - US-007
- Implemented RestController.UseConsumable() with real game API
- Searches GameData.PlayerInv.ALLSLOTS[] for matching item by name
- Uses case-insensitive string comparison for item name matching
- Implements FindItemHotkeySlot() to determine which keybind to press
  - Food items (bread, meat, fish, food, apple, cheese) -> slot 1
  - Drink items (water, potion, drink, juice, milk, ale) -> slot 2
  - Other consumables -> slot 3 (default)
- Uses InputController.UseAbilitySlot() to activate the item
- Returns bool for success/failure
- Null safety checks for PlayerInv and ALLSLOTS array
- Try/catch for graceful error handling during scene transitions
- Conditional compilation (#if !USE_REAL_GAME_TYPES) for stub mode
- Added IsFoodItem() and IsDrinkItem() helper methods
- All projects build with 0 warnings, 0 errors

**Files changed:**
- src/ErenshorGlider/Combat/RestController.cs - Implemented UseConsumable() with inventory search and slot detection

**Learnings for future iterations:**
- GameData.PlayerInv.ALLSLOTS[] contains all inventory slots
- InventorySlot.Item.ItemName is the item's display name
- Use StringComparison.OrdinalIgnoreCase for robust item name matching
- Item-to-hotkey mapping is heuristic-based; full implementation would track player's action bar setup
- Food/drink detection via keyword matching is a practical approach for MVP
- UseAbilitySlot() accepts slot numbers 1-9 corresponding to keyboard keys

**Build verification:**
- ErenshorGlider build: PASS (0 warnings, 0 errors)
- Typecheck: PASS
---

## [2025-02-05] - US-008
- Implemented waypoint delay waiting in WaypointPlayer
- Added _delayStartTime field (DateTime) to track when delay started
- Added _waitingForDelay flag (bool) to indicate we're in a wait state
- Updated Update() method to handle delay waiting:
  - Sets _delayStartTime when reaching waypoint with Delay > 0
  - Waits for Delay duration before advancing to next waypoint
  - Skips delay immediately if player enters combat during wait
- Added IsInCombat() helper to check combat state from PositionTracker
- Updated Stop() to clear _waitingForDelay flag
- All projects build with 0 warnings, 0 errors

**Files changed:**
- src/ErenshorGlider/Waypoints/WaypointPlayer.cs - Added delay waiting logic

**Learnings for future iterations:**
- Waypoint.Delay property is checked in Update() after reaching waypoint
- Combat state from PositionTracker.CurrentCombatState triggers delay skip
- DateTime.UtcNow - _delayStartTime calculates elapsed time
- Stop() should clear all state flags including _waitingForDelay
- This allows waiting for respawns at spawn points or NPC interactions

**Build verification:**
- ErenshorGlider build: PASS (0 warnings, 0 errors)
- Typecheck: PASS
---

## [2025-02-05] - US-009
- Implemented buff stack counting for combat rotation conditions
- Added GetBuffStacks() method to BuffState (returns 0 if buff not found)
- Added GetDebuffStacks() method to BuffState (returns 0 if debuff not found)
- Implemented ConditionType.BuffStackCount evaluation in Condition.Evaluate()
- Added EvaluateBuffStackCount() helper method
  - Checks buff/debuff by name via GetBuffStacks()
  - Compares stack count using all comparison operators (==, !=, <, <=, >, >=)
  - Returns false if buff not found or buffName is empty
- Supports both player and target buff checking via CheckTarget property
- All projects build with 0 warnings, 0 errors

**Files changed:**
- src/ErenshorGlider/GameState/BuffInfo.cs - Added GetBuffStacks() and GetDebuffStacks() methods
- src/ErenshorGlider/Combat/CombatProfile.cs - Implemented BuffStackCount condition evaluation

**Learnings for future iterations:**
- BuffState.GetBuffStacks() returns 0 if buff not found (graceful handling)
- Use BuffState.Value after null check for struct types to avoid compiler errors
- ConditionType.BuffStackCount uses the same Value and Operator properties as other numeric conditions
- All comparison operators (Equal, NotEqual, GreaterThan, GreaterThanOrEqual, LessThan, LessThanOrEqual) are supported
- CheckTarget property determines whether to check player or target buffs

**Build verification:**
- ErenshorGlider build: PASS (0 warnings, 0 errors)
- Typecheck: PASS
---

## [2025-02-05] - US-010
- End-to-end bot flow validation completed at code level
- All components integrated via GrindingBot state machine:
  - WaypointPlayer for pathing (with delay waiting from US-008)
  - TargetSelector for finding hostile mobs within range
  - CombatController for engagement and rotation execution
  - LootController for looting corpses
  - RestController for health/mana recovery (with consumable usage from US-007)
- InputController has Windows API simulation (US-003) for ability activation
- CombatController uses auto-attack via PlayerCombat API (US-005)
- InputController.TargetEntityById() supports direct entity targeting (US-006)
- CombatProfile supports buff stack counting conditions (US-009)
- Typecheck passes with 0 warnings, 0 errors
- Full runtime validation requires game testing (not possible in CI environment)

**Build verification:**
- ErenshorGlider build: PASS (0 warnings, 0 errors)
- Typecheck: PASS
---
